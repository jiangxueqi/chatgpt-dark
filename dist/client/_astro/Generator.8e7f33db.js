import{d as ne,e as x,f as u,g as h,h as p,i as f,S as Y,t as w,j as ge,n as _,o as ie,s as Se,p as M,q as fe,u as Be,v as Te,w as Le,x as B,y as de,F as ke,z as te,A as Pe,B as ve,C as xe,D as Re,E as je}from"./__vendor.250bfff5.js";import{M as Ne,m as Oe,a as Je,b as Ke}from"./__markdown.6bae04d9.js";/* empty css                       */import"./__highlight.9eb9bf1f.js";const ze=w('<div class="flex absolute items-center justify-between md:top-2 md:right-2 top--2 right-0 text-sm text-slate-7 dark:text-slate group-hover:opacity-100 group-focus:opacity-100 opacity-0 bg-slate bg-op-10"><!#><!/><!#><!/><!#><!/></div>'),Ye=w('<div class="flex items-center cursor-pointer p-2 hover:bg-slate hover:bg-op-20 text-1.2em"><button></button></div>');function qe(e){const[t,i]=x(!1);return u(Y,{get when(){return!e.hidden},get children(){const n=h(ze),l=n.firstChild,[s,r]=p(l.nextSibling),c=s.nextSibling,[d,m]=p(c.nextSibling),b=d.nextSibling,[E,y]=p(b.nextSibling);return f(n,u(ue,{label:"复制",onClick:()=>{i(!0),e.copy(),setTimeout(()=>i(!1),2e3)},get icon(){return t()?"i-un:copied":"i-un:copy"}}),s,r),f(n,u(ue,{label:"编辑",get onClick(){return e.edit},icon:"i-carbon:edit"}),d,m),f(n,u(ue,{label:"删除",get onClick(){return e.del},icon:"i-carbon:trash-can"}),E,y),n}})}function ue(e){return(()=>{const t=h(Ye),i=t.firstChild;return ge(t,"click",e.onClick,!0),_(n=>{const l=e.icon,s=e.label;return l!==n._v$&&ie(i,n._v$=l),s!==n._v$2&&Se(i,"title",n._v$2=s),n},{_v$:void 0,_v$2:void 0}),M(),t})()}ne(["click"]);function Ge(e){const t=e.renderer.rules.fence;e.renderer.rules.fence=(...i)=>{const[n,l]=i,s=n[l];s.info=s.info.replace(/\[.*\]/,"");const r=We(s.info);return t(...i).replace("<pre>",`<pre style="position: relative"><span class="lang">${r}</span><button title="Copy Code" class="copy"></button>`)}}const We=e=>e.trim().replace(/:(no-)?line-numbers({| |$).*/,"");async function me(e){try{return navigator.clipboard.writeText(e)}catch{const t=document.createElement("textarea"),i=document.activeElement;t.value=e,t.setAttribute("readonly",""),t.style.contain="strict",t.style.position="absolute",t.style.left="-9999px",t.style.fontSize="12pt";const n=document.getSelection(),l=n?n.rangeCount>0&&n.getRangeAt(0):null;document.body.appendChild(t),t.select(),t.selectionStart=0,t.selectionEnd=e.length,document.execCommand("copy"),document.body.removeChild(t),l&&(n.removeAllRanges(),n.addRange(l)),i&&i.focus()}}function Ue(){return/Mobi|Android|iPhone/i.test(navigator.userAgent)}function Ve(e,t="YYYY-mm-dd HH:MM"){let i;const n={"Y+":e.getFullYear().toString(),"m+":(e.getMonth()+1).toString(),"d+":e.getDate().toString(),"H+":e.getHours().toString(),"M+":e.getMinutes().toString(),"S+":e.getSeconds().toString()};return Object.entries(n).forEach(([l,s])=>{i=new RegExp("("+l+")").exec(t),i&&(t=t.replace(i[1],i[1].length==1?s:s.padStart(i[1].length,"0")))}),t}function Qe(){const e=new Map,t=i=>{const n=i.target;if(n.matches(".copy")){const l=n.parentElement,s=n.nextElementSibling;if(!l||!s)return;let r=s.innerText;me(r.trim()).then(()=>{n.classList.add("copied"),clearTimeout(e.get(n));const c=setTimeout(()=>{n.classList.remove("copied"),n.blur(),e.delete(n)},2e3);e.set(n,c)})}};fe(()=>{window.addEventListener("click",t)}),Be(()=>{window.removeEventListener("click",t)})}const Xe=w('<div class="group flex py-2 gap-3 px-4 transition-colors dark:md:hover:border relative message-item"><div></div><div class="message prose prose-white text-white break-words overflow-hidden"></div><!#><!/></div>'),_e=e=>{Qe();const t={system:"bg-white",user:"",assistant:"bg-white"},i=Ne({linkify:!0,breaks:!0}).use(Oe).use(Je,{inline:!0}).use(Ke).use(Ge);function n(){me(e.message)}function l(){e.setInputContent&&e.setInputContent(e.message)}function s(){e.setMessageList&&e.index!==void 0&&e.setMessageList(r=>{if(r[e.index]?.role==="user"){const c=r.reduce((d,m,b)=>(m.role==="assistant"&&b===d.at(-1)+1&&d.push(b),d),[e.index]);return r.filter((d,m)=>!c.includes(m))}return r.filter((c,d)=>d!==e.index)})}return(()=>{const r=h(Xe),c=r.firstChild,d=c.nextSibling,m=d.nextSibling,[b,E]=p(m.nextSibling);return f(r,u(qe,{del:s,copy:n,edit:l,get hidden(){return e.index===void 0}}),b,E),_(y=>{const S=e.index===void 0,T=`shrink-0 w-7 h-7 mt-4 rounded-full ${t[e.role]}`,F=i.render(e.message);return S!==y._v$&&r.classList.toggle("temporary",y._v$=S),T!==y._v$2&&ie(c,y._v$2=T),F!==y._v$3&&Te(d,y._v$3=F),y},{_v$:void 0,_v$2:void 0,_v$3:void 0}),r})()},we=w('<input type="password" class="max-w-150px ml-1em px-1 text-slate-7 dark:text-slate bg-slate bg-op-15 focus:bg-op-20 focus:ring-0 focus:outline-none">'),Ze=w('<input type="text" class="text-ellipsis max-w-150px ml-1em px-1 text-slate-7 dark:text-slate bg-slate bg-op-15 focus:bg-op-20 focus:ring-0 focus:outline-none">'),et=w('<input type="range" min="0" max="100" class="max-w-150px w-full h-2 bg-slate bg-op-15 appearance-none cursor-pointer accent-slate">'),ye=w(`<label class="relative inline-flex items-center cursor-pointer ml-1"><input type="checkbox" class="sr-only peer"><div class="w-9 h-5 bg-slate bg-op-15 peer-focus:outline-none peer-focus:ring-0  rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-slate"></div></label>`),tt=w('<div class="text-sm text-slate-7 dark:text-slate mb-2"><!#><!/><div class="mt-2 flex items-center justify-between"><!#><!/><div class="flex"><!#><!/><!#><!/><!#><!/><!#><!/><!#><!/></div></div></div>'),nt=w('<div class="flex items-center p-1 justify-between hover:bg-slate hover:bg-op-10"><div style="color: #ffffff;" class="flex items-center"><button></button><span ml-1></span></div><!#><!/></div>'),it=w('<div class="flex items-center cursor-pointer mx-1 p-2 hover:bg-slate hover:bg-op-10 text-1.2em"><button style="color: #ffffff;"></button></div>');function rt(e){const[t,i]=x(!1),[n,l]=x(!1);return(()=>{const s=h(tt),r=s.firstChild,[c,d]=p(r.nextSibling),m=c.nextSibling,b=m.firstChild,[E,y]=p(b.nextSibling),S=E.nextSibling,T=S.firstChild,[F,A]=p(T.nextSibling),q=F.nextSibling,[L,j]=p(q.nextSibling),G=L.nextSibling,[W,re]=p(G.nextSibling),U=W.nextSibling,[H,oe]=p(U.nextSibling),V=H.nextSibling,[J,Q]=p(V.nextSibling);return f(s,u(Y,{get when(){return t()},get children(){return[u(N,{icon:"i-ri:lock-password-line",label:"网站密码",get children(){const g=h(we);return g.$$input=v=>{e.setSetting({...e.setting(),password:v.target.value})},_(()=>g.value=e.setting().password),M(),g}}),u(N,{icon:"i-carbon:api",label:"OpenAI API Key",get children(){const g=h(we);return g.$$input=v=>{e.setSetting({...e.setting(),openaiAPIKey:v.target.value})},_(()=>g.value=e.setting().openaiAPIKey),M(),g}}),u(N,{icon:"i-carbon:user-online",label:"系统角色指令",get children(){const g=h(Ze);return g.$$input=v=>{e.setSetting({...e.setting(),systemRule:v.target.value})},_(()=>g.value=e.setting().systemRule),M(),g}}),u(N,{icon:"i-carbon:data-enrichment",label:"思维发散程度",get children(){const g=h(et);return g.$$input=v=>{e.setSetting({...e.setting(),openaiAPITemperature:Number(v.target.value)})},_(()=>g.value=String(e.setting().openaiAPITemperature)),M(),g}}),u(N,{icon:"i-carbon:save-image",label:"记录对话内容，刷新不会消失",get children(){const g=h(ye),v=g.firstChild;return v.addEventListener("change",K=>{e.setSetting({...e.setting(),archiveSession:K.target.checked})}),_(()=>v.checked=e.setting().archiveSession),g}}),u(N,{icon:"i-carbon:3d-curve-auto-colon",label:"开启连续对话，将加倍消耗 Token",get children(){const g=h(ye),v=g.firstChild;return v.addEventListener("change",K=>{e.setSetting({...e.setting(),continuousDialogue:K.target.checked})}),_(()=>v.checked=e.setting().continuousDialogue),g}})]}}),c,d),f(m,u(O,{onClick:()=>{i(!t())},icon:"i-carbon:settings",label:"设置"}),E,y),f(S,u(O,{onClick:ot,icon:"i-carbon:arrow-up",label:"回到顶部"}),F,A),f(S,u(O,{onClick:st,icon:"i-carbon:image",label:"导出图片"}),L,j),f(S,u(O,{label:"导出 Markdown",onClick:async()=>{await lt(e.messaages),l(!0),setTimeout(()=>l(!1),1e3)},get icon(){return n()?"i-ri:check-fill dark:text-yellow text-yellow-6":"i-ri:markdown-line"}}),W,re),f(S,u(O,{get onClick(){return e.reAnswer},icon:"i-carbon:reset",label:"重新回答"}),H,oe),f(S,u(O,{get onClick(){return e.clear},icon:"i-carbon:trash-can",label:"清空对话"}),J,Q),s})()}function N(e){return(()=>{const t=h(nt),i=t.firstChild,n=i.firstChild,l=n.nextSibling,s=i.nextSibling,[r,c]=p(s.nextSibling);return f(l,()=>e.label),f(t,()=>e.children,r,c),_(()=>ie(n,e.icon)),t})()}function O(e){return(()=>{const t=h(it),i=t.firstChild;return ge(t,"click",e.onClick,!0),_(n=>{const l=e.icon,s=e.label;return l!==n._v$&&ie(i,n._v$=l),s!==n._v$2&&Se(i,"title",n._v$2=s),n},{_v$:void 0,_v$2:void 0}),M(),t})()}function ot(){window.scrollTo({top:0,behavior:"smooth"})}function st(){Le(document.querySelector("#message-container"),{}).then(e=>{const t=document.createElement("a");t.href=e,t.download=`ChatGPT-${Ve(new Date,"HH-MM-SS")}.jpg`,t.click()})}async function lt(e){const t={system:"系统",user:"我",assistant:"ChatGPT"};await me(e.map(i=>`### ${t[i.role]}

${i.content.trim()}`).join(`



`))}ne(["input","click"]);const ct=w('<ul class="bg-slate bg-op-15 dark:text-slate text-slate-7 overflow-y-auto"></ul>'),at=w('<li class="hover:bg-slate hover:bg-op-20 py-1 px-3"><p></p><p class="text-0.4em"></p></li>');function ut(e){let t;const[i,n]=x(0),[l,s]=x("320px");return B(()=>{i()<0?n(0):i()&&i()>=e.prompts.length&&n(e.prompts.length-1)}),B(()=>{t&&e.prompts.length&&s(`${window.innerHeight-t.clientHeight>112?320:window.innerHeight-112}px`)}),fe(()=>{de(window,"keydown",r=>{r.key==="ArrowDown"?n(i()+1):r.key==="ArrowUp"?n(i()-1):r.key==="Enter"&&e.select(e.prompts[i()].prompt)},{passive:!0})}),(()=>{const r=h(ct),c=t;return typeof c=="function"?te(c,r):t=r,r.style.setProperty("color","#ffffff"),f(r,u(ke,{get each(){return e.prompts},children:(d,m)=>u(dt,{prompt:d,get select(){return e.select},get hover(){return i()===m()}})})),_(()=>r.style.setProperty("max-height",l())),r})()}function dt(e){let t;return B(()=>{e.hover&&(t.focus(),t.scrollIntoView({block:"center"}))}),(()=>{const i=h(at),n=i.firstChild,l=n.nextSibling;i.$$click=()=>{e.select(e.prompt.prompt)};const s=t;return typeof s=="function"?te(s,i):t=i,f(n,()=>e.prompt.desc),f(l,()=>e.prompt.prompt),_(r=>{const c=!!e.hover,d=!!e.hover;return c!==r._v$&&i.classList.toggle("bg-slate",r._v$=c),d!==r._v$2&&i.classList.toggle("bg-op-20",r._v$2=d),r},{_v$:void 0,_v$2:void 0}),M(),i})()}ne(["click"]);const gt=w('<div class="flex items-end border-2 border-white"><textarea id="input" placeholder="与 AI 对话" autocomplete="off" autofocus class="self-end py-3 resize-none w-full px-3 rounded-none focus:outline-none text-white bg-black placeholder:text-white placeholder:op-40"></textarea><div class="flex h-3em items-center rounded-none bg-black"><button title="发送" class="i-carbon:send-filled text-5 mx-3 text-white"></button></div></div>'),ft=w('<div class="mt-2"><div id="message-container"><!#><!/><!#><!/></div><div class="pb-2em fixed bottom-0 z-100 op-0"><!#><!/><!#><!/></div></div>'),mt=w('<div style="height: 52px;" class="h-12 flex items-center justify-center border-2 border-white bg-slate bg-op-15 text-white"><span>AI 正在思考...</span><div class="ml-1em px-2 py-0.5 border text-sm op-70 cursor-pointer hover:bg-white/10">停止</div></div>');function xt(e){let t,i;const{defaultMessage:n,defaultSetting:l,resetContinuousDialogue:s}=e.env,[r,c]=x([]),[d,m]=x(""),[b,E]=x(""),[y,S]=x(!1),[T,F]=x(),[A,q]=x(l),[L,j]=x([]),[G,W]=x("init"),re=new Pe(e.prompts,{selector:o=>`${o.desc} (${o.prompt})`}),[U,H]=x("48px"),[oe,V]=x(!0),J=ve(()=>{window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},250,{leading:!0,trailing:!1});fe(()=>{de(t,"compositionend",()=>{V(!0),he()},{passive:!0}),de(t,"compositionstart",()=>{V(!1)},{passive:!0}),document.querySelector("main")?.classList.remove("before"),document.querySelector("main")?.classList.add("after"),je(i,({width:$,height:I},P)=>{P===i&&W(`${$}px`)});const o=localStorage.getItem("setting"),a=localStorage.getItem("session");try{let $=!1;if(o){const I=JSON.parse(o);$=I.archiveSession,q({...l,...I,...s?{continuousDialogue:!1}:{}})}c(a&&$?JSON.parse(a):[{role:"assistant",content:n}])}catch{console.log("Setting parse error")}}),B(o=>(o!==void 0&&r().length>o&&J(),r().length)),B(()=>{b()&&J()}),B(o=>(r(),o&&(r().length===0?c([{role:"assistant",content:n}]):r().length>1&&r()[0].content===n&&c(r().slice(1)),A().archiveSession&&localStorage.setItem("session",JSON.stringify(r()))),!0)),B(()=>{localStorage.setItem("setting",JSON.stringify(A()))}),B(o=>{if(d(),o){if(H("48px"),d()==="")j([]);else{const{scrollHeight:a}=t;H(`${a>window.innerHeight-64?window.innerHeight-64:a}px`)}t.focus()}return!0});function Q(){b()&&(c([...r(),{role:"assistant",content:b().trim()}]),E(""),S(!1),F(),!Ue()&&t.focus())}async function g(o){const a=o??d();if(a){window?.umami&&umami.trackEvent("chat_generate"),m(""),(!o||o!==r().filter($=>$.role==="user").at(-1)?.content)&&c([...r(),{role:"user",content:a}]);try{await v(a)}catch($){S(!1),F(),E(String($).includes("aborted")?"":String($))}Q()}}async function v(o){S(!0);const a=new AbortController;F(a);const $=A().systemRule.trim(),I={role:"user",content:$?$+`
`+o:o},P=await fetch("/api",{method:"POST",body:JSON.stringify({messages:A().continuousDialogue?[...r().slice(0,-1),I]:[I],key:A().openaiAPIKey||void 0,temperature:A().openaiAPITemperature/100,password:A().password}),signal:a.signal});if(!P.ok)throw new Error(P.statusText);const X=P.body;if(!X)throw new Error("没有返回数据");const se=X.getReader(),le=new TextDecoder("utf-8");let R=!1;for(;!R;){const{value:Z,done:ee}=await se.read();if(Z){let z=le.decode(Z);if(z===`
`&&b().endsWith(`
`))continue;z&&E(b()+z)}R=ee}}function K(){c([]),E("")}function Ce(){T()&&(T()?.abort(),Q())}function Ee(){g(r().filter(o=>o.role==="user").at(-1)?.content)}function Ae(o){m(o),j([]);const{scrollHeight:a}=t;H(`${a>window.innerHeight-64?window.innerHeight-64:a}px`),t.focus()}const De=ve(o=>{if(o==="/"||o===" ")return j(e.prompts.slice(0,20));const a=o.replace(/^[\/ ](.*)/,"$1");a!==o&&j(re.find(a).map($=>$.item).slice(0,20))},250,{trailing:!1,leading:!0});async function he(){H("48px");const{scrollHeight:o}=t;if(H(`${o>window.innerHeight-64?window.innerHeight-64:o}px`),!oe())return;let{value:a}=t;m(a),De(a)}return(()=>{const o=h(ft),a=o.firstChild,$=a.firstChild,[I,P]=p($.nextSibling),X=I.nextSibling,[se,le]=p(X.nextSibling),R=a.nextSibling,Z=R.firstChild,[ee,z]=p(Z.nextSibling),Fe=ee.nextSibling,[Ie,Me]=p(Fe.nextSibling),be=i;return typeof be=="function"?te(be,o):i=o,a.style.setProperty("background-color","var(--c-bg)"),a.style.setProperty("margin-bottom","20px"),f(a,u(ke,{get each(){return r()},children:(k,C)=>u(_e,{get role(){return k.role},get message(){return k.content},get index(){return C()},setInputContent:m,setMessageList:c})}),I,P),f(a,(()=>{const k=xe(()=>!!b());return()=>k()&&u(_e,{role:"assistant",get message(){return b()}})})(),se,le),f(R,u(Y,{get when(){return xe(()=>!L().length)()&&U()==="48px"},get children(){return u(rt,{setting:A,setSetting:q,clear:K,reAnswer:Ee,get messaages(){return r()}})}}),ee,z),f(R,u(Y,{get when(){return!y()},fallback:()=>(()=>{const k=h(mt),C=k.firstChild,ce=C.nextSibling;return ce.$$click=Ce,M(),k})(),get children(){return[u(Y,{get when(){return L().length},get children(){return u(ut,{get prompts(){return L()},select:Ae})}}),(()=>{const k=h(gt),C=k.firstChild,ce=C.nextSibling,He=ce.firstChild;C.$$input=he,C.$$keydown=D=>{if(!D.isComposing){if(L().length)(D.key==="ArrowUp"||D.key==="ArrowDown"||D.key==="Enter")&&D.preventDefault();else if(D.key==="Enter")D.shiftKey||(D.preventDefault(),g());else if(D.key==="ArrowUp"){const pe=r().filter(ae=>ae.role==="user").map(ae=>ae.content).at(-1);pe&&!d()&&(D.preventDefault(),m(pe))}}},ge(C,"click",J,!0);const $e=t;return typeof $e=="function"?te($e,C):t=C,He.$$click=()=>g(),_(()=>C.style.setProperty("height",U())),_(()=>C.value=d()),M(),k})()]}}),Ie,Me),_(k=>Re(R,G()==="init"?{}:{transition:"opacity 1s ease-in-out",width:G(),opacity:100,"background-color":"var(--c-bg)"},k)),o})()}ne(["click","keydown","input"]);export{xt as default};
